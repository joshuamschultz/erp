<%= simple_form_for(@payable, :html => {:id => "form_for_paybles",:class => "form-horizontal"}) do |f| %>
<div class="row-fluid">
  <% if @payable.persisted? && @payable.po_header.nil? %>
        <%= render :partial => 'payables/payable_info' %>
  <% else %>
        <div class="span4 well item_detail_view">
            <div id="payable_po_header_info"></div>
        </div>
  <% end %>
  

  <div class="span8 well item_detail_view">

  <%= f.error_notification %>

  <div class="form-inputs">
    <% if @payable.po_header %>
        <% unless @payable.new_record? %>
            <%= f.input :po_header_id, :disabled => true, input_html: { class: 'special_font' }, :label => "PO" if @payable.po_header.present? %>
        <% else %>
            <%= f.association :po_header, :url => autocomplete_po_header_po_identifier_po_headers_path, :as => :autocomplete, :id_element => '#po_header_id', :label => "PO" %>
        <% end %>

        <%= hidden_field_tag :po_header_id, (@payable.po_header.id if @payable.po_header) %>

        <%= hidden_field_tag :org_po_header_id, (@payable.po_header.id if @payable.po_header) %>    

        <%#= f.association :po_header %>
        <%#= f.association :payable_to_address %>
        <%#= f.input :payable_active %>
        <%#= f.input :payable_identifier %>

        <% if @payable.new_record? || (@payable.persisted? && @payable.po_header.present?) %>
            <div class="control-group select optional payable_payable_to_address">
                <label for="payable_payable_to_id" class="select optional control-label">Payable To</label>
                <div class="controls">
                    <select name="payable[payable_to_id]" id="payable_payable_to_id" class="select optional">

                    </select>
                </div>
            </div>
        <% end %>
    <% end %>

    <%= f.input :payable_identifier, :label => "Invoice ID", required: true %>
    <%= f.input :payable_description, :label => "Description" %>        
    <%= f.input :payable_invoice_date, :as => :string, :label => "Invoice date" %>
    <%= f.input :payable_due_date, :as => :string, :label => "Due Date" %>
    <%= f.input :payable_notes, :label => "Notes" %>
    <%= f.input :payable_discount, :label => "Discount" %>
    <%#= f.input :payable_freight, :label => "Freight" %>    
    <%#= f.input :payable_cost, :disabled => true, input_html: { class: 'special_font' }, :label => "Cost" %>
    <%#= f.input :payable_total, :disabled => true, input_html: { class: 'special_font' }, :label => "Total" %>
  </div>

  <div class="separator bottom"></div>

  <div class="form-actions">
    <%= f.button :submit %>
    <%= link_to 'Delete', payable_path(@payable), method: :delete, data: { confirm: 'Are you sure?' }, :class => "btn" unless @payable.new_record? %>
    <%= link_to 'Back', @payable, :class => "btn" %>
  </div>

</div>
</div>
<% end %>

<%= render :partial => 'payables/po_shipments' if @po_header %>

<%= render :partial => 'payable_lines/line_items' if @payable.persisted? && @payable.po_header.nil? %>

<script type="text/javascript">
    tab_field_forms["form_for_paybles"] = ["payable_po_header_id", "payable_payable_to_id", "payable_payable_identifier", "payable_payable_description", "payable_payable_invoice_date", "payable_payable_due_date", "payable_payable_notes", "payable_payable_discount"];

    <% date_box_date1 = @payable.new_record? ? Date.today : @payable.payable_invoice_date %>
    <% date_box_date2 = @payable.new_record? ? Date.today : @payable.payable_due_date %>

    date_box_fields = date_box_fields.concat([{"name":"payable_payable_invoice_date", "value":"<%= date_box_date1 %>"}, {"name":"payable_payable_due_date", "value":"<%= date_box_date2 %>"}]);

    var payable_fine_to_submit = true;

    $(document).ready(function(){ 
        $("#payable_po_header_id").on("focusout", function(){
            if($("#po_header_id").val() == ""){
                $("#po_header_id").val($("#org_po_header_id").val());
            }

            if($("#po_header_id").val() != ""){
                initialize_api_call({"url": "/po_headers/" + $("#po_header_id").val() + "/po_info", "type": "GET", "params": {}}, "set_po_header_info", {});

                initialize_api_call({"url": "/contacts?contact_type=address&po_id=" + $("#po_header_id").val(), "type": "GET", "data_type": "json", "params": {}}, "set_vendor_addresses", {});
            }
            else{
                $("#payable_po_header_info").html("");
            }
        });

        <% unless @payable.nil? %>
            $("#payable_po_header_id").val("<%= @payable.po_header.po_identifier if @payable.po_header %>");

            if($("#po_header_id").val() != ""){
                initialize_api_call({"url": "/po_headers/" + $("#po_header_id").val() + "/po_info", "type": "GET", "params": {}}, "set_po_header_info", {});

                initialize_api_call({"url": "/contacts?contact_type=address&po_id=" + $("#po_header_id").val(), "type": "GET", "data_type": "json", "params": {}}, "set_vendor_addresses", {});
            }

            <% unless @payable.persisted? %>
                    $("#payable_po_header_id").focus();
            <% else %>
                    $("#payable_payable_identifier").focus();
            <% end %>

            // tab_field_forms["form_for_paybles"].push("payable_payable_discount");
        <% else %>
            $("#payable_po_header_id").focus();
        <% end %>

        $(document).on("keydown", ".payable_shipment_count", function(e){
            payable_fine_to_submit = true;
            payable_fine_to_submit = table_row_next_focus(e, "#form_for_paybles", $(this), ".payable_shipment_count", true);
        });

        $("#form_for_payments").submit(function(e){
            if(payable_fine_to_submit == false)
                e.preventDefault();
            else
                payable_fine_to_submit = true;
        });
    });

    function set_vendor_addresses(response, callback_params, api_params){
        var html = $.trim(Mustache.render($(".address-select-box-template").html(), response));
        $("#payable_payable_to_id").html(html);

        <% if @payable.persisted? && @payable.payable_to_address %>
                $("#payable_payable_to_id").val('<%= @payable.payable_to_id %>');
        <% end %>

        return false;
    }

    function set_po_header_info(response, callback_params, api_params){
        $("#payable_po_header_info").html(response);
        return false;
    }

</script>

<%= render :partial => 'layouts/app_layouts/mustache_templates', locals: {type: "address-select-box"} %>

<div class="separator bottom"></div>

<% @po_header = @payable.po_header if @payable.persisted? %>

<%= render :partial => 'po_lines/line_items' if @po_header %>